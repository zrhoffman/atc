#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
- name: hi
  hosts: localhost
  connection: local
  vars_files:
    - vars.yml
  tasks:
    - name: Get TO Cookie
      uri:
        validate_certs: no
        body_format: json
        url: "{{ dl_to_url }}/api/{{ dl_to_api_version }}/user/login"
        method: POST
        body: '{ "u":"{{ dl_to_user }}", "p":"{{ dl_to_user_password }}" }'
        headers:
          Content-Type: "application/x-www-form-urlencoded"
      register: dl_mojo_token
      no_log: true

    - name: Get TO User
      uri:
        validate_certs: no
        headers:
          Cookie: "{{ dl_mojo_token.set_cookie | default(omit) }}"
        body_format: json
        url: "{{ dl_to_url }}/api/{{ dl_to_api_version }}/user/current"
        method: GET
      register: current_user_out

    - name: Get All Delivery Services
      uri:
        validate_certs: no
        headers:
          Cookie: "{{ dl_mojo_token.set_cookie | default(omit) }}"
        body_format: json
        url: "{{ dl_to_url }}/api/{{ dl_to_api_version }}/deliveryservices"
        method: GET
      register: get_all_ds

    - name: Get All Types
      uri:
        validate_certs: no
        headers:
          Cookie: "{{ dl_mojo_token.set_cookie | default(omit) }}"
        body_format: json
        url: "{{ dl_to_url }}/api/{{ dl_to_api_version }}/types"
        method: GET
      register: get_all_types

    - name: Get DNS Delivery Service ID
      vars:
        dns_ds_id_query: 'response[?xmlId == `{{ dl_ds_merged_federation.deliveryService | to_json }}`].id | [0]'
      set_fact:
        dns_ds_id: "{{ get_all_ds.json | json_query(dns_ds_id_query) }}"

    - name: Create Federation
      vars:
        user_id: '{{ current_user_out.json | json_query("response.id") }}'
      uri:
        validate_certs: no
        headers:
          Cookie: "{{ dl_mojo_token.set_cookie | default(omit) }}"
        body_format: json
        url: "{{ dl_to_url }}/api/{{ dl_to_api_version }}/cdns/CDN-in-a-Box/federations"
        method: POST
        body: '{"cname":{{ dl_ds_merged_federation.mappings.cname | to_json }},"ttl":{{ dl_ds_merged_federation.mappings.ttl }},"dsId":{{ dns_ds_id }},"userId":{{ user_id }}}'
      register: create_federation_out

    - name: Get Federation ID
      vars:
        federation_id_query: response.id
      set_fact:
        federation_id: "{{ create_federation_out.json | json_query(federation_id_query) }}"

    - name: Assign User to Federation
      vars:
        user_id: '{{ current_user_out.json | json_query("response.id") }}'
      uri:
        validate_certs: no
        headers:
          Cookie: "{{ dl_mojo_token.set_cookie | default(omit) }}"
        body_format: json
        url: "{{ dl_to_url }}/api/{{ dl_to_api_version }}/federations/{{ federation_id }}/users"
        method: POST
        body: '{"userIds":[{{ user_id }}],"replace":false}'

    - name: Assign Delivery Service to Federation
      vars:
      uri:
        validate_certs: no
        headers:
          Cookie: "{{ dl_mojo_token.set_cookie | default(omit) }}"
        body_format: json
        url: "{{ dl_to_url }}/api/{{ dl_to_api_version }}/federations/{{ federation_id }}/deliveryservices"
        method: POST
        body: '{"dsIds":[{{ dns_ds_id }}],"replace":false}'

    - name: Create IPv4 Federation Resolvers
      with_items: "{{ dl_ds_merged_federation.mappings.resolve4 }}"
      vars:
        type_name: RESOLVE4
        type_query: "[?name == `{{ type_name }}`].id | [0]"
        resolve4_type_id: "{{ get_all_types.json.response | json_query(type_query) }}"
      uri:
        validate_certs: no
        headers:
          Cookie: "{{ dl_mojo_token.set_cookie | default(omit) }}"
        body_format: json
        url: "{{ dl_to_url }}/api/{{ dl_to_api_version }}/federation_resolvers"
        method: POST
        body: '{"ipAddress":{{ item | to_json }},"typeId":{{ resolve4_type_id }}}'
      register: ipv4_federation_resolver_out

    - name: Create IPv6 Federation Resolvers
      with_items: "{{ dl_ds_merged_federation.mappings.resolve6 }}"
      vars:
        type_name: RESOLVE6
        type_query: "[?name == `{{ type_name }}`].id | [0]"
        resolve6_type_id: "{{ get_all_types.json.response | json_query(type_query) }}"
      uri:
        validate_certs: no
        headers:
          Cookie: "{{ dl_mojo_token.set_cookie | default(omit) }}"
        body_format: json
        url: "{{ dl_to_url }}/api/{{ dl_to_api_version }}/federation_resolvers"
        method: POST
        body: '{"ipAddress":{{ item | to_json }},"typeId":{{ resolve6_type_id }}}'
      register: ipv6_federation_resolver_out

    - name: Get Federation Resolver IDs
      uri:
        validate_certs: no
        headers:
          Cookie: "{{ dl_mojo_token.set_cookie | default(omit) }}"
        #body_format: json
        url: "{{ dl_to_url }}/api/{{ dl_to_api_version }}/federation_resolvers"
        method: GET
      register: federation_resolver_ids_out

    - name: Assign Federation Resolvers to Federation
      vars:
        federation_resolver_ids_query: 'response[].id'
      uri:
        validate_certs: no
        headers:
          Cookie: "{{ dl_mojo_token.set_cookie | default(omit) }}"
        body_format: json
        url: "{{ dl_to_url }}/api/{{ dl_to_api_version }}/federations/{{ federation_id }}/federation_resolvers"
        method: POST
        body: '{"fedResolverIds":{{ federation_resolver_ids_out.json | json_query(federation_resolver_ids_query) }},"replace":true}'
