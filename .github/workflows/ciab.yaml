# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

name: CDN-in-a-Box CI

on: push

jobs:
  source:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Build RPM
        uses: ./.github/actions/build-rpms
        env:
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload RPM
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}
          path: ${{ github.workspace }}/dist/apache-trafficcontrol-*.tar.gz

  traffic_monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Build RPM
        uses: ./.github/actions/build-rpms
        env:
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload RPM
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}
          path: ${{ github.workspace }}/dist/${{ github.job }}-*.rpm
      - name: Build ${{ github.job }} CDN-in-a-Box image
        uses: ./.github/actions/ciab-image
        env:
          RPM_PATHS: ${{ github.job }}/${{ github.job }}.rpm
          CIAB_IMAGES: ${{ github.job }} # Underscores are stripped
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload Docker images
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}-images
          path: ${{ github.workspace }}/ciab-images/docker-${{ github.job }}.tar.gz

  traffic_ops:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Build RPM
        uses: ./.github/actions/build-rpms
        env:
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload RPM
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}
          path: ${{ github.workspace }}/dist/${{ github.job }}-*.rpm
      - name: Build ${{ github.job }} CDN-in-a-Box image
        uses: ./.github/actions/ciab-image
        env:
          RPM_PATHS: ${{ github.job }}/${{ github.job }}.rpm
          CIAB_IMAGES: ${{ github.job }},${{ github.job }}-perl # Underscores are stripped
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload Docker images
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}-images
          path: ${{ github.workspace }}/ciab-images/docker-${{ github.job }}.tar.gz

  traffic_ops_ort:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Build RPM
        uses: ./.github/actions/build-rpms
        env:
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload RPM
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}
          path: ${{ github.workspace }}/dist/${{ github.job }}-*.rpm
      - name: Build ${{ github.job }} CDN-in-a-Box image
        uses: ./.github/actions/ciab-image
        env:
          RPM_PATHS: cache/${{ github.job }}.rpm
          CIAB_IMAGES: edge,mid # Underscores are stripped
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload Docker images
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}-images
          path: ${{ github.workspace }}/ciab-images/docker-${{ github.job }}.tar.gz

  traffic_portal:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Build RPM
        uses: ./.github/actions/build-rpms
        env:
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload RPM
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}
          path: ${{ github.workspace }}/dist/${{ github.job }}-*.rpm
      - name: Build ${{ github.job }} CDN-in-a-Box image
        uses: ./.github/actions/ciab-image
        env:
          RPM_PATHS: ${{ github.job }}/${{ github.job }}.rpm
          CIAB_IMAGES: ${{ github.job }} # Underscores are stripped
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload Docker images
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}-images
          path: ${{ github.workspace }}/ciab-images/docker-${{ github.job }}.tar.gz

  traffic_router:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Build RPM
        uses: ./.github/actions/build-rpms
        env:
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload RPM
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}
          path: ${{ github.workspace }}/dist/*.rpm
      - name: Build ${{ github.job }} CDN-in-a-Box image
        uses: ./.github/actions/ciab-image
        env:
          RPM_PATHS: ${{ github.job }}/${{ github.job }}.rpm,${{ github.job }}/tomcat.rpm
          CIAB_IMAGES: ${{ github.job }} # Underscores are stripped
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload Docker images
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}-images
          path: ${{ github.workspace }}/ciab-images/docker-${{ github.job }}.tar.gz

  traffic_stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Build RPM
        uses: ./.github/actions/build-rpms
        env:
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload RPM
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}
          path: ${{ github.workspace }}/dist/${{ github.job }}-*.rpm
      - name: Build ${{ github.job }} CDN-in-a-Box image
        uses: ./.github/actions/ciab-image
        env:
          RPM_PATHS: ${{ github.job }}/${{ github.job }}.rpm
          CIAB_IMAGES: ${{ github.job }} # Underscores are stripped
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload Docker images
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}-images
          path: ${{ github.workspace }}/ciab-images/docker-${{ github.job }}.tar.gz

  grove:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Build RPM
        uses: ./.github/actions/build-rpms
        env:
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload RPM
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}
          path: ${{ github.workspace }}/dist/${{ github.job }}-*.rpm

  grovetccfg:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Build RPM
        uses: ./.github/actions/build-rpms
        env:
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload RPM
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}
          path: ${{ github.workspace }}/dist/${{ github.job }}-*.rpm

  docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Build ${{ github.job }}
        uses: ./.github/actions/build-rpms
        env:
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload archive
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}
          path: ${{ github.workspace }}/dist/apache-trafficcontrol-*-docs.tar.gz

  db:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Build ${{ github.job }} CDN-in-a-Box image
        uses: ./.github/actions/ciab-image
        env:
          CIAB_IMAGES: ${{ github.job }} # Underscores are stripped
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload Docker images
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}-images
          path: ${{ github.workspace }}/ciab-images/docker-${{ github.job }}.tar.gz

  dns:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Build ${{ github.job }} CDN-in-a-Box image
        uses: ./.github/actions/ciab-image
        env:
          CIAB_IMAGES: ${{ github.job }} # Underscores are stripped
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload Docker images
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}-images
          path: ${{ github.workspace }}/ciab-images/docker-${{ github.job }}.tar.gz

  enroller:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Build ${{ github.job }} CDN-in-a-Box image
        uses: ./.github/actions/ciab-image
        env:
          CIAB_IMAGES: ${{ github.job }} # Underscores are stripped
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload Docker images
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}-images
          path: ${{ github.workspace }}/ciab-images/docker-${{ github.job }}.tar.gz

  influxdb:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Build ${{ github.job }} CDN-in-a-Box image
        uses: ./.github/actions/ciab-image
        env:
          CIAB_IMAGES: ${{ github.job }} # Underscores are stripped
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload Docker images
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}-images
          path: ${{ github.workspace }}/ciab-images/docker-${{ github.job }}.tar.gz

  origin:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Build ${{ github.job }} CDN-in-a-Box image
        uses: ./.github/actions/ciab-image
        env:
          CIAB_IMAGES: ${{ github.job }} # Underscores are stripped
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload Docker images
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}-images
          path: ${{ github.workspace }}/ciab-images/docker-${{ github.job }}.tar.gz

  smtp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Build ${{ github.job }} CDN-in-a-Box image
        uses: ./.github/actions/ciab-image
        env:
          CIAB_IMAGES: ${{ github.job }},readiness # Underscores are stripped
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload Docker images
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}-images
          path: ${{ github.workspace }}/ciab-images/docker-${{ github.job }}.tar.gz

  traffic_vault:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Build ${{ github.job }} CDN-in-a-Box image
        uses: ./.github/actions/ciab-image
        env:
          CIAB_IMAGES: ${{ github.job }} # Underscores are stripped
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload Docker images
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.job }}-images
          path: ${{ github.workspace }}/ciab-images/docker-${{ github.job }}.tar.gz

  ciab-build:
    runs-on: ubuntu-latest
    needs:
      - db
      - dns
      - enroller
      - influxdb
      - origin
      - smtp
      - traffic_monitor
      - traffic_ops
      - traffic_ops_ort
      - traffic_portal
      - traffic_router
      - traffic_stats
      - traffic_vault
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Download CDN-in-a-Box images
        uses: actions/download-artifact@v2
        with:
          path: ${{ github.workspace }}/ciab-images/
      - name: Start CDN-in-a-Box
        uses: ./.github/actions/run-ciab
      - name: Delete CDN-in-a-Box image artifacts
        uses: geekyeggo/delete-artifact@1-glob-support
        if: ${{ always() }}
        with:
          name: '*-images'
          useGlob: true